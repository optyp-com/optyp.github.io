---
/**
 * OPTYP Cookie Banner Component
 * Fully GDPR / CCPA / DPDP compliant
 * Works with Footer.astro + CookiePreferences.astro
 */
---

<!-- Desktop Cookie Banner -->
<div id="cookie-banner"
     class="fixed bottom-0 left-0 right-0 bg-gradient-to-br from-gray-900 via-black to-gray-900 text-white border-t border-teal-400/40 py-4 px-6 shadow-lg z-50 hidden sm:flex items-center justify-between flex-wrap font-body">

  <!-- Message -->
  <p class="text-sm sm:text-base max-w-2xl leading-relaxed mb-3 sm:mb-0">
    üç™ We use cookies to improve your experience, analyze traffic, and personalize content. 
    By clicking <strong>‚ÄúAccept‚Äù</strong>, you consent to our use of cookies as described in our 
    <a href="/cookies/" class="text-teal-400 underline hover:text-green-400">Cookies Policy</a>.
  </p>

  <!-- Actions -->
  <div class="flex space-x-3 shrink-0">
    <button id="cookieAcceptBtn"
            class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
      Accept
    </button>
    <button id="cookieRejectBtn"
            class="bg-gray-700 hover:bg-gray-800 text-gray-200 px-4 py-2 rounded-lg text-sm font-semibold transition">
      Reject
    </button>
    <button id="cookieManageBtn"
            class="bg-transparent text-teal-400 underline hover:text-green-400 text-sm font-semibold transition">
      Manage
    </button>
  </div>
</div>

<!-- Mobile Cookie Banner -->
<div id="cookie-banner-mobile"
     class="fixed bottom-0 left-0 right-0 bg-black/90 text-white border-t border-teal-400/40 py-4 px-4 shadow-lg z-50 sm:hidden hidden">
  <p class="text-sm leading-relaxed">
    We use cookies to improve your experience. 
    <a href="/cookies/" class="text-teal-400 underline hover:text-green-400">Learn more</a>.
  </p>
  <div class="mt-3 flex justify-end space-x-3">
    <button id="cookieAcceptBtnMobile"
            class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded-lg text-sm font-semibold transition">Accept</button>
    <button id="cookieRejectBtnMobile"
            class="bg-gray-700 hover:bg-gray-800 text-gray-200 px-3 py-1 rounded-lg text-sm font-semibold transition">Reject</button>
  </div>
</div>

<!-- ‚úÖ Functional Cookie Script (Runs Client-Side) -->
<script client:load>
(function() {
  const banner = document.getElementById('cookie-banner');
  const bannerMobile = document.getElementById('cookie-banner-mobile');
  const acceptBtn = document.getElementById('cookieAcceptBtn');
  const rejectBtn = document.getElementById('cookieRejectBtn');
  const manageBtn = document.getElementById('cookieManageBtn');
  const acceptBtnMobile = document.getElementById('cookieAcceptBtnMobile');
  const rejectBtnMobile = document.getElementById('cookieRejectBtnMobile');

  // Helper: check if consent exists
  function hasConsent() {
    return localStorage.getItem('cookieConsent') !== null;
  }

  // Show the banner
  function showBanner() {
    banner?.classList.remove('hidden');
    bannerMobile?.classList.remove('hidden');
  }

  // Hide the banner
  function hideBanner() {
    banner?.classList.add('hidden');
    bannerMobile?.classList.add('hidden');
  }

  // Save user's choice in localStorage
  function saveConsent(status) {
    try {
      localStorage.setItem('cookieConsent', status);
      const prefs = {
        essential: true,
        analytics: status === 'accepted',
        marketing: status === 'accepted'
      };
      localStorage.setItem('cookiePreferences', JSON.stringify(prefs));

      // Notify other scripts (e.g., Google Analytics loader)
      window.dispatchEvent(new CustomEvent('cookiePreferencesSaved', { detail: prefs }));
    } catch (err) {
      console.warn('Cookie consent could not be saved:', err);
    }
  }

  // Button Handlers
  function handleAccept() {
    saveConsent('accepted');
    hideBanner();
  }

  function handleReject() {
    saveConsent('rejected');
    hideBanner();
  }

  function handleManage() {
    hideBanner();
    window.dispatchEvent(new CustomEvent('openCookieModal'));
  }

  // Event Bindings
  acceptBtn?.addEventListener('click', handleAccept);
  rejectBtn?.addEventListener('click', handleReject);
  manageBtn?.addEventListener('click', handleManage);
  acceptBtnMobile?.addEventListener('click', handleAccept);
  rejectBtnMobile?.addEventListener('click', handleReject);

  // Show on first visit
  if (!hasConsent()) {
    showBanner();
  }

  // Re-show banner if user clears consent
  window.addEventListener('storage', (e) => {
    if (e.key === 'cookieConsent' && e.newValue === null) {
      showBanner();
    }
  });
})();
</script>

<style>
  #cookie-banner, #cookie-banner-mobile {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  #cookie-banner.show, #cookie-banner-mobile.show {
    opacity: 1;
    transform: translateY(0);
  }
  #cookie-banner.hidden, #cookie-banner-mobile.hidden {
    opacity: 0;
    transform: translateY(100%);
  }
</style>
