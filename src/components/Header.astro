---
// src/components/Header.astro
---
<header id="site-header" class="bg-transparent sticky top-0 z-50 transition-all duration-500">
  <div class="container mx-auto flex items-center justify-between px-4 py-3">
    <!-- Logo -->
    <a href="/" class="flex items-center space-x-3" aria-label="OPTYP home">
      <img src="/images/logo.svg" alt="OPTYP Logo" class="h-10 w-auto" />
      <span class="font-bold text-xl tracking-wide text-white">OPTYP</span>
    </a>

    <!-- Mobile Menu Button -->
    <button
      id="mobile-menu-button"
      class="md:hidden focus:outline-none focus:ring-2 focus:ring-cyan-400 rounded"
      aria-label="Toggle Menu"
      aria-expanded="false"
    >
      <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="2"
        viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <line x1="3" y1="12" x2="21" y2="12" />
        <line x1="3" y1="6" x2="21" y2="6" />
        <line x1="3" y1="18" x2="21" y2="18" />
      </svg>
    </button>

    <!-- Desktop Navigation -->
    <nav class="hidden md:flex items-center space-x-6 font-semibold text-gray-200" role="navigation" aria-label="Primary">
      <a href="/#hero" class="nav-link" data-section="hero">Home</a>
      <a href="/#about" class="nav-link" data-section="about">About</a>
      <a href="/#services" class="nav-link" data-section="services">Services</a>
      <a href="/#plans" class="nav-link" data-section="plans">Plans</a>
      <a href="/#testimonials" class="nav-link" data-section="testimonials">Testimonials</a>
      <a href="/#contact" class="nav-link" data-section="contact">Contact</a>

      <!-- CTA -->
      <button
        id="header-cta"
        class="ml-2 glass-btn px-4 py-2 rounded-lg text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-cyan-400"
        aria-haspopup="dialog"
        aria-controls="contact-modal"
      >
        Get Started
      </button>
    </nav>
  </div>

  <!-- Mobile Navigation -->
  <nav id="mobile-menu"
       class="md:hidden fixed inset-x-4 top-16 bg-black/70 backdrop-blur-md border border-white/6 rounded-xl shadow-lg hidden p-4 space-y-2 font-semibold text-white z-50"
       aria-hidden="true"
  >
    <a href="/#hero" class="nav-link block py-2 px-3 rounded-md">Home</a>
    <a href="/#about" class="nav-link block py-2 px-3 rounded-md">About</a>
    <a href="/#services" class="nav-link block py-2 px-3 rounded-md">Services</a>
    <a href="/#plans" class="nav-link block py-2 px-3 rounded-md">Plans</a>
    <a href="/#testimonials" class="nav-link block py-2 px-3 rounded-md">Testimonials</a>
    <a href="/#contact" class="nav-link block py-2 px-3 rounded-md">Contact</a>
    <button id="mobile-cta" class="w-full glass-btn text-center px-4 py-2 rounded-md font-semibold mt-2" aria-haspopup="dialog" aria-controls="contact-modal">
      Get Started
    </button>
  </nav>

  <script is:inline>
    // Elements
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const header = document.getElementById('site-header');
    const navLinks = Array.from(document.querySelectorAll('.nav-link'));
    const headerCTA = document.getElementById('header-cta');
    const mobileCTA = document.getElementById('mobile-cta');
    const sections = Array.from(document.querySelectorAll('section[id]'));

    // Mobile toggle
    function toggleMobileMenu() {
      const expanded = button.getAttribute('aria-expanded') === 'true';
      if (expanded) {
        menu.classList.add('hidden');
        menu.setAttribute('aria-hidden', 'true');
        button.setAttribute('aria-expanded', 'false');
      } else {
        menu.classList.remove('hidden');
        menu.setAttribute('aria-hidden', 'false');
        button.setAttribute('aria-expanded', 'true');
        // focus first link for accessibility
        const first = menu.querySelector('.nav-link');
        if (first) first.focus();
      }
    }
    button?.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMobileMenu();
    });

    // Close mobile menu when clicking outside (accessibility-friendly)
    document.addEventListener('click', (e) => {
      if (!menu.classList.contains('hidden') && !e.target.closest('#mobile-menu') && !e.target.closest('#mobile-menu-button')) {
        menu.classList.add('hidden');
        menu.setAttribute('aria-hidden', 'true');
        button.setAttribute('aria-expanded', 'false');
      }
    });

    // Scrollspy: highlight nav link for current section
    function setActive(sectionId) {
      navLinks.forEach(link => {
        const target = (link.dataset && link.dataset.section) || (link.getAttribute('href') || '').split('#')[1];
        if (target === sectionId) {
          link.classList.add('text-cyan-300','font-bold','bg-white/2','border-b-0');
        } else {
          link.classList.remove('text-cyan-300','font-bold','bg-white/2','border-b-0');
        }
      });
    }

    try {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) setActive(entry.target.id);
        });
      }, { threshold: 0.6 });
      sections.forEach(section => observer.observe(section));
    } catch (err) {
      // IntersectionObserver not supported: no scrollspy
    }

    // Smooth scroll for normal anchors and special handling for #contact links (open modal)
    function handleNavClick(e, link) {
      const href = link.getAttribute('href') || '';
      const hash = href.includes('#') ? href.split('#')[1] : null;

      // If clicking contact target, open contact modal (if function available) else smooth scroll fallback
      if (hash === 'contact') {
        e.preventDefault();
        if (typeof openContactForm === 'function') {
          openContactForm();
        } else {
          // fallback: smooth scroll to contact section if exists
          const el = document.getElementById('contact');
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // close mobile menu if open
        if (!menu.classList.contains('hidden')) { menu.classList.add('hidden'); button.setAttribute('aria-expanded','false'); }
        return;
      }

      if (hash) {
        const target = document.getElementById(hash);
        if (target) {
          e.preventDefault();
          const top = target.getBoundingClientRect().top + window.pageYOffset - 70;
          window.scrollTo({ top, behavior: 'smooth' });
        }
      }

      // close mobile menu on any nav click
      if (!menu.classList.contains('hidden')) {
        menu.classList.add('hidden');
        button.setAttribute('aria-expanded','false');
      }
    }

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => handleNavClick(e, link));
      // keyboard accessibility (Enter/Space)
      link.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          handleNavClick(ev, link);
        }
      });
    });

    // CTA buttons open contact modal too (if available)
    function attachCTAOpen(btn) {
      if (!btn) return;
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        if (typeof openContactForm === 'function') openContactForm();
        else {
          const el = document.getElementById('contact');
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // close mobile menu when CTA clicked
        if (!menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded','false');
        }
      });
    }
    attachCTAOpen(headerCTA);
    attachCTAOpen(mobileCTA);

    // Header glass effect on scroll (mobile-first: light change close to top)
    function updateHeaderOnScroll() {
      const sc = window.scrollY || window.pageYOffset;
      if (sc > 50) {
        header.classList.add('bg-black/70','backdrop-blur-sm','shadow-lg','border-b','border-white/6');
        header.classList.remove('bg-transparent');
      } else {
        header.classList.remove('bg-black/70','backdrop-blur-sm','shadow-lg','border-b','border-white/6');
        header.classList.add('bg-transparent');
      }
    }
    window.addEventListener('scroll', updateHeaderOnScroll, { passive: true });
    updateHeaderOnScroll();

    // Close mobile menu and handle escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (!menu.classList.contains('hidden')) {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded','false');
        }
      }
    });
  </script>

  <style>
    /* Basic nav link styling + neon hover */
    .nav-link {
      padding: 0.25rem 0.5rem;
      border-radius: 0.35rem;
      color: #e6eef1;
      transition: all 0.2s ease;
      outline: none;
    }
    .nav-link:focus {
      box-shadow: 0 0 0 3px rgba(0,255,204,0.08);
    }
    .nav-link:hover {
      color: #00ffd1;
      text-shadow: 0 0 8px rgba(0,255,204,0.12);
      transform: translateY(-1px);
    }

    /* Glass CTA used in header */
    .glass-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      color: #00ffd1;
      backdrop-filter: blur(6px);
      transition: all 0.18s ease;
    }
    .glass-btn:hover {
      background: rgba(0,255,204,0.06);
      box-shadow: 0 6px 22px rgba(0,255,204,0.08);
      color: #fff;
      transform: translateY(-2px);
    }

    /* Small screens - ensure mobile menu looks clean and accessible */
    @media (max-width: 767px) {
      #mobile-menu { left: 0.5rem; right: 0.5rem; top: 4rem; }
      #mobile-menu a.nav-link { display: block; width: 100%; }
    }
  </style>
</header>
