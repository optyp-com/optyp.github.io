---
import "../styles/ai-analyzer.css";
---

<section class="ai-container">
  <h2 class="title">Optimize Smarter with AI</h2>
  <p class="subtitle">
    Instantly get your <strong>ATS Resume Score</strong> and <strong>LinkedIn Profile Rating</strong> powered by Google Gemini ‚Äî free, fast, and accurate.
  </p>

  <div class="ai-grid">
    <!-- Resume Analyzer -->
    <div class="glass-card hover-card">
      <h3 class="card-title">ATS Resume Score</h3>
      <form id="resume-form" class="form">
        <input
          type="file"
          id="resume-upload"
          accept=".pdf,.doc,.docx,.txt"
          class="input-file"
        />
        <textarea
          id="job-description"
          placeholder="Paste Job Description (optional)"
          class="input-area"
        ></textarea>
        <button type="submit" class="btn-primary">Analyze Resume</button>
      </form>

      <div id="resume-result" class="result-box"></div>
    </div>

    <!-- LinkedIn Analyzer -->
    <div class="glass-card hover-card">
      <h3 class="card-title">LinkedIn Profile Score</h3>
      <form id="linkedin-form" class="form">
        <input
          type="url"
          id="linkedin-url"
          placeholder="Paste LinkedIn Profile URL"
          class="input-text"
        />
        <button type="submit" class="btn-secondary">Analyze Profile</button>
      </form>

      <div id="linkedin-result" class="result-box"></div>
    </div>
  </div>
</section>

<script>
  // === üåÄ SHOW LOADING SPINNER ===
  function showLoading(targetId) {
    const container = document.getElementById(targetId);
    container.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner-circle"></div>
        <div class="loading-text">Analyzing with AI<span class="dots"></span></div>
      </div>
    `;
  }

  // === üß† EXTRACT SCORE FROM AI TEXT ===
  function extractScore(text) {
    const match = text.match(/(\d{1,3})\s*\/\s*100|score[:\s]*(\d{1,3})/i);
    const score = match ? parseInt(match[1] || match[2]) : null;
    return Math.min(Math.max(score || 0, 0), 100);
  }

  // === ‚ú® EXTRACT RECOMMENDATIONS FROM AI TEXT ===
  function extractRecommendations(text) {
    const sectionRegex = /(recommendations|suggestions|tips|improvements)[:\s]*([\s\S]*)/i;
    const match = text.match(sectionRegex);
    if (!match) return null;

    const recommendationsText = match[2]
      .split(/\n|\r|\d+\.|[-*‚Ä¢]/)
      .map(line => line.trim())
      .filter(line => line.length > 3);

    return recommendationsText;
  }

  // === üíé RENDER RESULT (SCORE + BULLETS + FULL TEXT) ===
  function renderResult(targetId, text) {
    const container = document.getElementById(targetId);
    container.innerHTML = "";

    const score = extractScore(text);
    const recommendations = extractRecommendations(text);

    if (score) {
      const label =
        score >= 85 ? "Excellent ‚úÖ" : score >= 60 ? "Good üëç" : "Needs Improvement ‚ö†Ô∏è";

      container.innerHTML = `
        <div class="score-section">
          <div class="score-label">${label}</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: ${score}%;"></div>
          </div>
          <div class="score-value">${score}/100</div>
        </div>
      `;
    }

    if (recommendations && recommendations.length > 0) {
      const formatted = recommendations
        .map(item => `‚úÖ ${item.charAt(0).toUpperCase() + item.slice(1)}`)
        .join("<br>");
      container.innerHTML += `
        <div class="recommendations-section">
          <h4 class="rec-title">Recommendations</h4>
          <div class="rec-list">${formatted}</div>
        </div>
      `;
    }

    container.innerHTML += `
      <div class="result-text">
        <details>
          <summary>üìÑ Full AI Analysis</summary>
          <pre>${text}</pre>
        </details>
      </div>
    `;
  }

  // === üßæ HANDLE RESUME ANALYSIS ===
  async function handleResume(e) {
    e.preventDefault();
    const file = document.getElementById("resume-upload").files[0];
    if (!file) return alert("Please upload a resume file.");
    const text = await file.text();
    const jobDesc = document.getElementById("job-description").value;

    showLoading("resume-result");
    const res = await fetch("/.netlify/functions/analyze-resume", {
      method: "POST",
      body: JSON.stringify({ resumeText: text, jobDescription: jobDesc }),
    });
    const data = await res.json();
    renderResult("resume-result", data.result);
  }

  // === üîó HANDLE LINKEDIN ANALYSIS ===
  async function handleLinkedIn(e) {
    e.preventDefault();
    const url = document.getElementById("linkedin-url").value;
    if (!url) return alert("Please enter your LinkedIn URL.");

    showLoading("linkedin-result");
    const res = await fetch("/.netlify/functions/analyze-linkedin", {
      method: "POST",
      body: JSON.stringify({ profileUrl: url }),
    });
    const data = await res.json();
    renderResult("linkedin-result", data.result);
  }

    // === EVENT LISTENERS (Fixed for Astro hydration) ===
  document.addEventListener("DOMContentLoaded", () => {
    const resumeForm = document.getElementById("resume-form");
    const linkedinForm = document.getElementById("linkedin-form");

    if (resumeForm) {
      resumeForm.addEventListener("submit", handleResume);
    }

    if (linkedinForm) {
      linkedinForm.addEventListener("submit", handleLinkedIn);
    }
  });
</script>
